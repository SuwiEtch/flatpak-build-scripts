#!/bin/bash

# Make sure flatpack and ostree are available in the cron job's PATH
export PATH=@@PREFIX@@/bin:$PATH

logdir=@@WORKDIR@@/export/logs/build-$(date +%Y-%m-%e-%H%M%S)
logfile=${logdir}/build.log

mkdir -p "${logdir}"

echo "====================================================" >> $logfile
echo "Starting build at `date`" >> $logfile
echo "====================================================" >> $logfile

# Just manually time it in seconds
#
startime=$(date +%s)
@@TOPDIR@@/build-payload.sh --workdir @@WORKDIR@@ --config @@CONFIG@@ --logdir ${logdir} >> $logfile
error_code=$?
endtime=$(date +%s)

seconds=$((endtime-startime))
duration=$((seconds/86400))" days "$(date -d "1970-01-01 + $seconds seconds" "+%H hours %M minutes %S seconds")

echo "====================================================" >> $logfile
if [ "${error_code}" -eq "0" ]; then
    echo "Build completed successfully in: $duration" >> $logfile
else
    echo "Build failed in: $duration" >> $logfile
fi
echo "====================================================" >> $logfile
